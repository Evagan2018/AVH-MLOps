# This YAML file is used to test a custom Docker image with the necessary tools and dependencies for an ML project
# It contains a job that runs tests on a Ubuntu machine using the custom Docker image

name: Licensed Docker Image - Test

on:
  # Trigger the workflow when a workflow run is completed
  workflow_run:
    workflows: ["Licensed Docker Image - Build and Push"]
    types:
      - completed
  # Trigger the workflow manually
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/avh-mlops

jobs:

  check-docker-image:
    runs-on: ubuntu-latest
    outputs:
      image-exists: ${{ steps.check.outputs.exists }}
      repo-slug: ${{ steps.slug.outputs.repo_slug }}
    steps:
      - name: Derive lowercase repo slug
        id: slug
        run: echo "repo_slug=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Check if Docker image exists
        id: check
        run: |
          if docker manifest inspect ghcr.io/$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')/arm-mlops-docker-licensed:latest > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Diagnosis
        run: |
          echo "Repository Slug: ${{ steps.slug.outputs.repo_slug }}"
          echo "Image Exists: ${{ steps.check.outputs.exists }}"

  run_test:
    needs: check-docker-image
    runs-on: ubuntu-latest

    container:
      # Use the custom Docker image with the necessary tools and dependencies
      image: ghcr.io/${{ needs.check-docker-image.outputs.repo-slug }}/arm-mlops-docker-licensed:latest
      credentials:
        # Set the Docker image credentials using the actor and a GitHub token
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        # Check out the repository containing the ML project
        uses: actions/checkout@v5

      # Diagnostic steps to understand the workspace and vcpkg setup starting here
      - name: Debug workspace
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          pwd
          ls -la
          # Look for artifact/manifest files at the repo root:
          ls -la vcpkg-configuration.json vcpkg-artifacts.json || true
          # If theyâ€™re supposed to be in a subdir, show that too:
          ls -la tools/ci || true

      - name: vcpkg project probe
        run: |
          vcpkg --version
          vcpkg activate --dry-run || true
          echo "Contents of root:"
          ls -la
          echo "Try known subdirs:"
          for d in build ci tools docker_base docker_licensed; do
            [ -d "$d" ] && { echo "== $d =="; ls -la "$d"; }
          done
      # Diagnostic steps to understand the workspace and vcpkg setup ending here

      - name: Use vcpkg to install tools (if manifest exists)
        if: ${{ hashFiles('vcpkg-configuration.json', 'vcpkg-artifacts.json') != '' }}
        run: |
          vcpkg activate --downloads-root=. --json=env.json

      # Action under test
      - name: Activate vcpkg environment
        run: |
          vcpkg-shell activate ./docker_base/vcpkg-configuration.json

      - name: cbuild testproject
        # Test if the armclang command is working in the Docker container
        run: |
          cbuild get_started.csolution.yml --packs --update-rte --context .debug+avh
  
